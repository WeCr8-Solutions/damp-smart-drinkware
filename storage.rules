rules_version = '2';

// Cloud Storage Security Rules for DAMP Smart Drinkware
service firebase.storage {
  match /b/{bucket}/o {
    
    // =============================================================================
    // USER AVATARS
    // =============================================================================
    
    // Avatar uploads - users can only upload their own avatars
    match /avatars/{userId}/{fileName} {
      // Allow read for all authenticated users (public avatars)
      allow read: if request.auth != null;
      
      // Allow write only for the specific user
      allow write: if request.auth != null && request.auth.uid == userId
                   && isValidAvatarUpload();
      
      // Allow delete only by the user or admin
      allow delete: if request.auth != null && 
                    (request.auth.uid == userId || isAdmin());
    }
    
    // =============================================================================
    // DEVICE ATTACHMENTS (Future use)
    // =============================================================================
    
    // Device images and attachments
    match /devices/{deviceId}/{fileName} {
      // Users can read device attachments they own
      allow read: if request.auth != null && userOwnsDevice(deviceId);
      
      // Users can upload device attachments for their own devices
      allow write: if request.auth != null && userOwnsDevice(deviceId)
                   && isValidDeviceFile();
      
      // Users can delete their own device attachments
      allow delete: if request.auth != null && userOwnsDevice(deviceId);
    }
    
    // =============================================================================
    // ADMIN UPLOADS
    // =============================================================================
    
    // Admin-only uploads (app assets, etc.)
    match /admin/{fileName} {
      allow read: if true; // Public read
      allow write, delete: if isAdmin();
    }
    
    // =============================================================================
    // PUBLIC ASSETS
    // =============================================================================
    
    // Public assets (product images, marketing materials)
    match /public/{allPaths=**} {
      allow read: if true; // Public read access
      allow write: if isAdmin(); // Only admins can modify
    }
    
    // =============================================================================
    // HELPER FUNCTIONS
    // =============================================================================
    
    // Check if user is admin
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.role == 'admin';
    }
    
    // Check if user owns a specific device
    function userOwnsDevice(deviceId) {
      // This would require a Firestore lookup, which isn't directly possible in Storage rules
      // In practice, you'd implement this check in your Cloud Function before upload
      return request.auth != null;
    }
    
    // Validate avatar upload constraints
    function isValidAvatarUpload() {
      // File size limit: 5MB
      return request.resource.size <= 5 * 1024 * 1024
             // Only allow image files
             && request.resource.contentType.matches('image/.*')
             // Allowed image types
             && (request.resource.contentType == 'image/jpeg' ||
                 request.resource.contentType == 'image/png' ||
                 request.resource.contentType == 'image/webp' ||
                 request.resource.contentType == 'image/gif');
    }
    
    // Validate device file uploads
    function isValidDeviceFile() {
      // File size limit: 10MB for device files
      return request.resource.size <= 10 * 1024 * 1024
             // Allow images and documents
             && (request.resource.contentType.matches('image/.*') ||
                 request.resource.contentType == 'application/pdf' ||
                 request.resource.contentType.matches('text/.*'));
    }
  }
}