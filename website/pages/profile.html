<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - DAMP Smart Drinkware</title>

    <!-- Core Styles -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="../assets/css/navigation.css">
    <link rel="stylesheet" href="../assets/css/auth-styles.css">

    <!-- Load Environment Configuration -->
    <script src="../assets/js/env-config.js"></script>

    <style>
        .profile-container {
            max-width: 1000px;
            margin: 120px auto 40px;
            padding: 0 20px;
        }

        .profile-header {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 30px rgb(0 0 0 / 30%);
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 48px;
            color: white;
            box-shadow: 0 8px 25px rgb(0 212 255 / 40%);
        }

        .profile-name {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .profile-email {
            color: var(--text-secondary);
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .profile-joined {
            color: var(--text-muted);
            font-size: 1rem;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgb(255 255 255 / 5%);
            border: 1px solid rgb(255 255 255 / 10%);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            background: rgb(0 212 255 / 10%);
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgb(0 212 255 / 20%);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: block;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .profile-section {
            background: rgb(255 255 255 / 5%);
            border: 1px solid rgb(255 255 255 / 10%);
            border-radius: 15px;
            padding: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .profile-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .profile-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: none;
            font-size: 1rem;
        }

        .profile-btn.primary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .profile-btn.primary:hover {
            background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgb(0 212 255 / 40%);
        }

        .profile-btn.secondary {
            background: rgb(255 255 255 / 10%);
            color: var(--text-color);
            border: 1px solid rgb(255 255 255 / 20%);
        }

        .profile-btn.secondary:hover {
            background: rgb(255 255 255 / 20%);
            transform: translateY(-2px);
        }

        .recent-activity {
            list-style: none;
            padding: 0;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid rgb(255 255 255 / 10%);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .activity-content {
            flex-grow: 1;
        }

        .activity-text {
            color: var(--text-color);
            margin-bottom: 4px;
        }

        .activity-time {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .loading-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .auth-required {
            text-align: center;
            padding: 60px 20px;
        }

        .auth-required-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (width <= 768px) {
            .profile-sections {
                grid-template-columns: 1fr;
            }

            .profile-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .profile-header {
                padding: 30px 20px;
            }

            .profile-name {
                font-size: 2rem;
            }

            .profile-actions {
                justify-content: center;
            }
        }

        @media (width <= 480px) {
            .profile-stats {
                grid-template-columns: 1fr;
            }

            .profile-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <damp-header></damp-header>

    <main>
        <!-- Loading State -->
        <div id="profileLoading" class="loading-state">
            <div class="profile-container">
                <h2>Loading your profile...</h2>
                <p>Please wait while we load your DAMP account information.</p>
            </div>
        </div>

        <!-- Authentication Required -->
        <div id="authRequired" class="auth-required" style="display: none;">
            <div class="profile-container">
                <div class="auth-required-icon">üîê</div>
                <h2>Authentication Required</h2>
                <p>You need to be signed in to view your profile.</p>
                <div class="profile-actions">
                    <button class="profile-btn primary" onclick="dampAuth.showSignIn()">üîë Sign In</button>
                    <button class="profile-btn secondary" onclick="dampAuth.showSignUp()">üìù Create Account</button>
                </div>
            </div>
        </div>

        <!-- Profile Content -->
        <div id="profileContent" class="profile-container" style="display: none;">
            <div class="profile-header">
                <div class="profile-avatar" id="profileAvatar">üë§</div>
                <h1 class="profile-name" id="profileName">Loading...</h1>
                <p class="profile-email" id="profileEmail">loading@example.com</p>
                <p class="profile-joined" id="profileJoined">Member since...</p>
            </div>

            <div class="profile-stats">
                <div class="stat-card">
                    <span class="stat-icon">üó≥Ô∏è</span>
                    <div class="stat-number" id="votesCount">0</div>
                    <div class="stat-label">Votes Cast</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üì¶</span>
                    <div class="stat-number" id="ordersCount">0</div>
                    <div class="stat-label">Orders</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">‚≠ê</span>
                    <div class="stat-number" id="reviewsCount">0</div>
                    <div class="stat-label">Reviews</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üéØ</span>
                    <div class="stat-number" id="pointsCount">0</div>
                    <div class="stat-label">Loyalty Points</div>
                </div>
            </div>

            <div class="profile-sections">
                <div class="profile-section">
                    <h2 class="section-title">üéØ Quick Actions</h2>
                    <div class="profile-actions">
                        <a href="../test-voting-system.html" class="profile-btn primary">üó≥Ô∏è Vote on Products</a>
                        <a href="../pages/pre-order.html" class="profile-btn secondary">üõí Pre-Order</a>
                        <button class="profile-btn secondary" onclick="updateProfile()">‚öôÔ∏è Edit Profile</button>
                    </div>
                </div>

                <div class="profile-section">
                    <h2 class="section-title">üìà Recent Activity</h2>
                    <ul class="recent-activity" id="recentActivity">
                        <li class="activity-item">
                            <div class="activity-icon">üéâ</div>
                            <div class="activity-content">
                                <div class="activity-text">Welcome to DAMP!</div>
                                <div class="activity-time">Account created</div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <!-- Load Firebase Services -->
    <script type="module">
        import {
            auth,
            db,
            initializeFirebaseServices
        } from '../assets/js/firebase-services.js';

        import { DAMPAuthService } from '../assets/js/auth-service.js';

        // Initialize services
        try {
            await initializeFirebaseServices();

            const authService = new DAMPAuthService(auth, db);

            window.firebaseServices = {
                auth,
                db,
                authService
            };

            console.log('‚úÖ Profile page: Firebase services loaded');
        } catch (error) {
            console.warn('‚ö†Ô∏è Profile page: Firebase services failed:', error);
        }
    </script>

    <!-- Load Authentication Components -->
    <script src="../assets/js/auth-modal.js"></script>
    <script src="../assets/js/components/header.js"></script>

    <script>
        let currentUser = null;
        let authService = null;

        // Initialize profile page
        document.addEventListener('DOMContentLoaded', function() {
            initializeProfile();
        });

        async function initializeProfile() {
            // Wait for Firebase services
            await waitForFirebaseServices();

            // Set up auth state listener
            if (window.firebaseServices?.authService) {
                authService = window.firebaseServices.authService;
                authService.onAuthStateChange(handleAuthStateChange);
            } else {
                showAuthRequired();
            }
        }

        function waitForFirebaseServices() {
            return new Promise((resolve) => {
                const checkServices = () => {
                    if (window.firebaseServices?.authService) {
                        resolve();
                    } else {
                        setTimeout(checkServices, 500);
                    }
                };
                checkServices();
            });
        }

        function handleAuthStateChange(user) {
            currentUser = user;

            if (user) {
                showProfileContent(user);
            } else {
                showAuthRequired();
            }

            hideLoading();
        }

        async function showProfileContent(user) {
            // Update profile header
            document.getElementById('profileName').textContent = user.displayName || user.email?.split('@')[0] || 'DAMP User';
            document.getElementById('profileEmail').textContent = user.email || 'No email provided';

            const joinedDate = user.metadata?.creationTime ?
                new Date(user.metadata.creationTime).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }) : 'Unknown';
            document.getElementById('profileJoined').textContent = `Member since ${joinedDate}`;

            // Update avatar
            const avatar = document.getElementById('profileAvatar');
            if (user.photoURL) {
                avatar.innerHTML = `<img src="${user.photoURL}" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            } else {
                const initial = (user.displayName || user.email || '?')[0].toUpperCase();
                avatar.textContent = initial;
            }

            // Load user stats (simulated for now)
            await loadUserStats(user);

            // Load recent activity
            loadRecentActivity(user);

            // Show profile content
            document.getElementById('profileContent').style.display = 'block';
            document.getElementById('authRequired').style.display = 'none';
        }

        function showAuthRequired() {
            document.getElementById('profileContent').style.display = 'none';
            document.getElementById('authRequired').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('profileLoading').style.display = 'none';
        }

        async function loadUserStats(user) {
            // In a real app, these would come from your backend
            const stats = {
                votes: Math.floor(Math.random() * 10) + 1,
                orders: Math.floor(Math.random() * 3),
                reviews: Math.floor(Math.random() * 5),
                points: Math.floor(Math.random() * 500) + 100
            };

            // Animate the numbers
            animateStatNumber('votesCount', stats.votes);
            animateStatNumber('ordersCount', stats.orders);
            animateStatNumber('reviewsCount', stats.reviews);
            animateStatNumber('pointsCount', stats.points);
        }

        function animateStatNumber(elementId, targetValue) {
            const element = document.getElementById(elementId);
            let currentValue = 0;
            const increment = targetValue / 30;

            const animation = setInterval(() => {
                currentValue += increment;
                if (currentValue >= targetValue) {
                    element.textContent = targetValue;
                    clearInterval(animation);
                } else {
                    element.textContent = Math.floor(currentValue);
                }
            }, 50);
        }

        function loadRecentActivity(user) {
            const activities = [
                { icon: 'üéâ', text: 'Welcome to DAMP!', time: 'Account created' },
                { icon: 'üó≥Ô∏è', text: 'Voted for DAMP Handle v2.0', time: '2 days ago' },
                { icon: 'üìß', text: 'Subscribed to newsletter', time: '1 week ago' }
            ];

            const activityList = document.getElementById('recentActivity');
            activityList.innerHTML = activities.map(activity => `
                <li class="activity-item">
                    <div class="activity-icon">${activity.icon}</div>
                    <div class="activity-content">
                        <div class="activity-text">${activity.text}</div>
                        <div class="activity-time">${activity.time}</div>
                    </div>
                </li>
            `).join('');
        }

        function signIn() {
            if (window.dampAuth) {
                window.dampAuth.showSignIn();
            }
        }

        function signUp() {
            if (window.dampAuth) {
                window.dampAuth.showSignUp();
            }
        }

        function updateProfile() {
            alert('Profile editing feature coming soon! üöÄ\n\nYou\'ll be able to:\n‚Ä¢ Update display name\n‚Ä¢ Change profile picture\n‚Ä¢ Manage preferences\n‚Ä¢ View order history');
        }
    </script>
</body>
</html>