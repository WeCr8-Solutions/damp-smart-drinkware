# Netlify configuration for DAMP Smart Drinkware
# Optimized for static site with serverless functions

[build]
  # Static site - no build step required
  publish = "website"
  functions = "netlify/functions"
  # Ignore Firebase API keys (they're safe for client-side use)
  ignore_secrets = true
  
[build.environment]
  # Use Node 20 LTS for functions (Firebase requires Node 20+)
  NODE_VERSION = "20.11.0"
  # Handle peer dependency warnings
  NPM_FLAGS = "--legacy-peer-deps"
  # Disable secrets scanning for Firebase API keys (safe for client-side)
  SECRETS_SCAN_SMART_DETECTION_ENABLED = "false"

# Netlify Dev configuration for local testing
[dev]
  command = ""
  targetPort = 8888
  port = 8888
  publish = "website"
  functionsPort = 34567
  framework = "#static"

# Enhanced security headers with comprehensive Firebase and Google services support
[[headers]]
  for = "/*"
  [headers.values]
    Content-Security-Policy = """
      default-src 'self';
      base-uri 'self';
      object-src 'none';
      frame-ancestors 'self';
      upgrade-insecure-requests;

      script-src 'self' 'unsafe-inline' 'unsafe-eval'
        https://www.gstatic.com
        https://apis.google.com
        https://*.firebase.com
        https://*.firebaseapp.com
        https://*.googleapis.com
        https://www.googletagmanager.com
        https://www.google-analytics.com
        https://pagead2.googlesyndication.com
        https://googleads.g.doubleclick.net
        https://tpc.googlesyndication.com
        https://ep1.adtrafficquality.google
        https://ep2.adtrafficquality.google
        https://*.adtrafficquality.google
        https://js.stripe.com
        https://checkout.stripe.com;

      script-src-elem 'self' 'unsafe-inline'
        https://www.gstatic.com
        https://apis.google.com
        https://*.firebase.com
        https://*.firebaseapp.com
        https://*.googleapis.com
        https://www.googletagmanager.com
        https://www.google-analytics.com
        https://pagead2.googlesyndication.com
        https://googleads.g.doubleclick.net
        https://tpc.googlesyndication.com
        https://ep1.adtrafficquality.google
        https://ep2.adtrafficquality.google
        https://ep1.adtrafficquality.google/sodar
        https://ep2.adtrafficquality.google/sodar
        https://ep2.adtrafficquality.google/sodar/sodar2.js
        https://js.stripe.com
        https://checkout.stripe.com;

      connect-src 'self'
        https://www.google-analytics.com
        https://www.googletagmanager.com
        https://www.gstatic.com
        https://*.gstatic.com
        https://firestore.googleapis.com
        https://firebasestorage.googleapis.com
        https://fcm.googleapis.com
        https://firebaseremoteconfig.googleapis.com
        https://firebaseinstallations.googleapis.com
        https://securetoken.googleapis.com
        https://identitytoolkit.googleapis.com
        https://oauth2.googleapis.com
        https://www.googleapis.com
        https://firebase.googleapis.com
        https://ep1.adtrafficquality.google
        https://pagead2.googlesyndication.com
        https://googleads.g.doubleclick.net
        https://api.stripe.com
        wss://*.firebase.com;

      frame-src 'self'
        https://accounts.google.com
        https://*.firebaseapp.com
        https://js.stripe.com
        https://checkout.stripe.com
        https://pagead2.googlesyndication.com
        https://googleads.g.doubleclick.net
        https://tpc.googlesyndication.com;

      img-src 'self' data: blob:
        https://www.google-analytics.com
        https://www.googletagmanager.com
        https://pagead2.googlesyndication.com
        https://googleads.g.doubleclick.net
        https://tpc.googlesyndication.com
        https://*.gstatic.com
        https://*.googleusercontent.com
        https://firebasestorage.googleapis.com
        https://images.unsplash.com
        https://dampdrink.com;

      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;

      font-src 'self' https://fonts.gstatic.com data:;

      worker-src 'self';
      manifest-src 'self';
      media-src 'self' blob:;
      child-src 'self';
      form-action 'self' https://checkout.stripe.com https://formspree.io;
    """
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "geolocation=(), microphone=(), camera=()"
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"

# JavaScript module files - correct MIME type for ES6 modules
[[headers]]
  for = "/*.js"
  [headers.values]
    Content-Type = "application/javascript; charset=utf-8"
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/assets/js/*.js"
  [headers.values]
    Content-Type = "application/javascript; charset=utf-8"
    Cache-Control = "public, max-age=31536000, immutable"

# Static assets - Long cache with immutable
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Images - Long cache
[[headers]]
  for = "/images/*"
  [headers.values]
    Cache-Control = "public, max-age=2592000"

# HTML files - Short cache
[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "public, max-age=3600"

# Service Workers - No cache
[[headers]]
  for = "/sw.js"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"
    Content-Type = "application/javascript; charset=utf-8"

[[headers]]
  for = "/firebase-messaging-sw.js"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"
    Content-Type = "application/javascript; charset=utf-8"

# Staging environment
[context.deploy-preview]
  [context.deploy-preview.environment]
    ENVIRONMENT = "staging"

# Production environment
[context.production]
  [context.production.environment]
    ENVIRONMENT = "production"

# Branch deploys
[context.branch-deploy]
  [context.branch-deploy.environment]
    ENVIRONMENT = "development"

# API redirects for serverless functions (MUST BE FIRST)
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200

# Force HTTPS and www redirect
[[redirects]]
  from = "http://dampdrink.com/*"
  to = "https://dampdrink.com/:splat"
  status = 301
  force = true

[[redirects]]
  from = "http://www.dampdrink.com/*"
  to = "https://dampdrink.com/:splat"
  status = 301
  force = true

[[redirects]]
  from = "https://www.dampdrink.com/*"
  to = "https://dampdrink.com/:splat"
  status = 301
  force = true

# Legacy redirects
[[redirects]]
  from = "/old-page"
  to = "/new-page"
  status = 301

# SPA routing fallback - ONLY for actual 404s
# This should NOT redirect existing HTML files
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
  conditions = {exceptions = ["*.js", "*.css", "*.png", "*.jpg", "*.jpeg", "*.gif", "*.svg", "*.ico", "*.woff", "*.woff2", "*.ttf", "*.eot", "*.json", "*.xml", "*.txt", "*.webp", "*.html"]}
