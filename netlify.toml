# Netlify configuration for DAMP Smart Drinkware - Professional Security

[build]
  command = "echo 'Building website directory - no build needed for static site'"
  publish = "website"
  
[build.environment]
  NODE_VERSION = "18"
  NETLIFY_NEXT_PLUGIN_SKIP = "true"

# Explicitly disable plugins that shouldn't run
[[plugins]]
  package = "@netlify/plugin-nextjs"
  [plugins.inputs]
    disabled = true

[[plugins]]
  package = "@netlify/plugin-lighthouse"
  [plugins.inputs]
    disabled = false

# Enhanced security headers with comprehensive Firebase and Google services support
[[headers]]
  for = "/*"
  [headers.values]
    Content-Security-Policy = """
      default-src 'self';
      base-uri 'self';
      object-src 'none';
      frame-ancestors 'self';
      upgrade-insecure-requests;

      script-src 'self' 'unsafe-inline' 'unsafe-eval'
        https://www.gstatic.com
        https://apis.google.com
        https://*.firebase.com
        https://*.firebaseapp.com
        https://*.googleapis.com
        https://www.googletagmanager.com
        https://www.google-analytics.com
        https://pagead2.googlesyndication.com
        https://googleads.g.doubleclick.net
        https://tpc.googlesyndication.com
        https://js.stripe.com
        https://checkout.stripe.com;

      script-src-elem 'self' 'unsafe-inline'
        https://www.gstatic.com
        https://apis.google.com
        https://*.firebase.com
        https://*.firebaseapp.com
        https://*.googleapis.com
        https://www.googletagmanager.com
        https://www.google-analytics.com
        https://pagead2.googlesyndication.com
        https://googleads.g.doubleclick.net
        https://tpc.googlesyndication.com
        https://js.stripe.com
        https://checkout.stripe.com;

      connect-src 'self'
        https://www.google-analytics.com
        https://www.googletagmanager.com
        https://firestore.googleapis.com
        https://firebasestorage.googleapis.com
        https://fcm.googleapis.com
        https://firebaseremoteconfig.googleapis.com
        https://securetoken.googleapis.com
        https://identitytoolkit.googleapis.com
        https://oauth2.googleapis.com
        https://www.googleapis.com
        https://firebase.googleapis.com
        https://ep1.adtrafficquality.google
        https://pagead2.googlesyndication.com
        https://googleads.g.doubleclick.net
        https://api.stripe.com
        wss://*.firebase.com;

      frame-src 'self'
        https://accounts.google.com
        https://js.stripe.com
        https://checkout.stripe.com
        https://pagead2.googlesyndication.com
        https://googleads.g.doubleclick.net
        https://tpc.googlesyndication.com;

      img-src 'self' data: blob:
        https://www.google-analytics.com
        https://www.googletagmanager.com
        https://pagead2.googlesyndication.com
        https://googleads.g.doubleclick.net
        https://tpc.googlesyndication.com
        https://*.gstatic.com
        https://*.googleusercontent.com
        https://firebasestorage.googleapis.com
        https://images.unsplash.com
        https://dampdrink.com;

      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;

      font-src 'self' https://fonts.gstatic.com data:;

      worker-src 'self';
      manifest-src 'self';
      media-src 'self' blob:;
      child-src 'self';
      form-action 'self' https://checkout.stripe.com https://formspree.io;
    """
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "geolocation=(), microphone=(), camera=()"
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"

# Static assets - Long cache with immutable
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Images - Long cache
[[headers]]
  for = "/images/*"
  [headers.values]
    Cache-Control = "public, max-age=2592000"

# HTML files - Short cache
[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "public, max-age=3600"

# Service Workers - No cache
[[headers]]
  for = "/sw.js"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"
    Content-Type = "application/javascript"

[[headers]]
  for = "/firebase-messaging-sw.js"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"
    Content-Type = "application/javascript"

# Staging environment
[context.deploy-preview]
  [context.deploy-preview.environment]
    ENVIRONMENT = "staging"

# Production environment
[context.production]
  [context.production.environment]
    ENVIRONMENT = "production"

# Branch deploys
[context.branch-deploy]
  [context.branch-deploy.environment]
    ENVIRONMENT = "development"

# Force HTTPS and www redirect
[[redirects]]
  from = "http://dampdrink.com/*"
  to = "https://dampdrink.com/:splat"
  status = 301
  force = true

[[redirects]]
  from = "http://www.dampdrink.com/*"
  to = "https://dampdrink.com/:splat"
  status = 301
  force = true

[[redirects]]
  from = "https://www.dampdrink.com/*"
  to = "https://dampdrink.com/:splat"
  status = 301
  force = true

# SPA routing fallback (should be last)
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# API redirects for serverless functions
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200

# Legacy redirects
[[redirects]]
  from = "/old-page"
  to = "/new-page"
  status = 301